<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Menos 15 · Voz</title>
  <style>
    :root{
      --bg:#0b0f14;
      --ink:#eaf2ff;
      --muted:rgba(234,242,255,.55);
      --btn:rgba(234,242,255,.18);
      --btnOn:#eaf2ff;
      --shadow: rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .wrap{
      width:min(420px, 92vw);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
      text-align:center;
      padding:28px 18px;
    }
    .hint{
      font-size:14px;
      color:var(--muted);
      line-height:1.35;
      min-height:38px;
    }
    .value{
      font-size:44px;
      letter-spacing:.02em;
      font-weight:650;
      min-height:54px;
    }
    .chip{
      font-size:13px;
      color:var(--muted);
      padding:6px 10px;
      border:1px solid rgba(234,242,255,.12);
      border-radius:999px;
      user-select:none;
    }
    .mic{
      width:120px;height:120px;border-radius:999px;
      background:var(--btn);
      border:1px solid rgba(234,242,255,.12);
      box-shadow: 0 18px 60px var(--shadow);
      display:grid;place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, background .12s ease;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
    }
    .mic:active{ transform: scale(.98); }
    .mic.on{
      background:var(--btnOn);
      color:#0b0f14;
    }
    .mic svg{ width:40px;height:40px; }
    .small{ font-size:12px; color:var(--muted); opacity:.85; }
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="chip">Toca una vez → habla → suelta silencio → ⌊0,85×n⌋</div>

    <div class="value" id="result">—</div>
    <div class="hint" id="status">Toca el micro y di “54”.</div>

    <div class="mic" id="mic" aria-label="Hablar" role="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"/>
        <path d="M19 11a7 7 0 0 1-14 0"/>
        <path d="M12 19v3"/>
        <path d="M8 22h8"/>
      </svg>
    </div>

    <div class="row">
      <div class="small" id="heard"></div>
    </div>

    <div class="small" id="compat"></div>
  </div>

<script>
(() => {
  const $mic    = document.getElementById('mic');
  const $status = document.getElementById('status');
  const $result = document.getElementById('result');
  const $heard  = document.getElementById('heard');
  const $compat = document.getElementById('compat');

  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  const canRec = !!SpeechRec;
  const canTTS = 'speechSynthesis' in window;

  $compat.textContent = canRec
    ? 'Reconocimiento: OK · Voz: ' + (canTTS ? 'OK' : 'No')
    : 'Este navegador no soporta reconocimiento de voz.';

  // -------- TTS (iOS-friendly) --------
  let ttsUnlocked = false;

  function pickSpanishVoice() {
    const voices = window.speechSynthesis?.getVoices?.() || [];
    return voices.find(v => (v.lang || '').toLowerCase().startsWith('es-es'))
        || voices.find(v => (v.lang || '').toLowerCase().startsWith('es'))
        || null;
  }

  if (canTTS) {
    window.speechSynthesis.onvoiceschanged = () => {};
    window.speechSynthesis.getVoices();
  }

  // Desbloquea TTS en gesto usuario (iOS)
  function unlockTTS() {
    if (!canTTS || ttsUnlocked) return;
    try {
      const u = new SpeechSynthesisUtterance(' ');
      u.lang = 'es-ES';
      u.volume = 0; // mudo
      u.rate = 1.0;
      u.voice = pickSpanishVoice() || undefined;
      window.speechSynthesis.speak(u);
      ttsUnlocked = true;
    } catch {}
  }

  function speak(text){
    if(!canTTS) return;
    try {
      window.speechSynthesis.resume();
      const u = new SpeechSynthesisUtterance(String(text));
      u.lang = 'es-ES';
      u.rate = 1.0;
      u.volume = 1.0;
      u.voice = pickSpanishVoice() || undefined;
      window.speechSynthesis.speak(u);
    } catch {}
  }

  // -------- Parse / math --------
  function parseNumber(raw){
    if(!raw) return null;
    const t = raw
      .toLowerCase()
      .replaceAll('€','')
      .replaceAll('%','')
      .replace(/\s+/g,'')
      .replace(/\.(?=\d{3}(\D|$))/g,'')
      .replaceAll(',','.');
    const m = t.match(/-?\d+(\.\d+)?/);
    if(!m) return null;
    const n = Number(m[0]);
    return Number.isFinite(n) ? n : null;
  }

  function discountFloor15(n){
    return Math.floor(n * 0.85);
  }

  // -------- Recognition flow (tap → stop on silence) --------
  let rec = null;
  let finalText = '';
  let interimText = '';
  let isListening = false;

  function cleanup() {
    if (rec) {
      try { rec.onresult = rec.onerror = rec.onend = rec.onspeechend = null; } catch {}
      rec = null;
    }
    isListening = false;
    $mic.classList.remove('on');
  }

  function forceStop() {
    if (!rec) return;
    try { rec.stop(); } catch {}
  }

  function startListening() {
    if (!canRec) {
      $status.textContent = 'Tu navegador no puede escucharte.';
      setTimeout(() => speak('Tu navegador no puede reconocer voz.'), 120);
      return;
    }
    if (isListening) return;

    isListening = true;
    finalText = '';
    interimText = '';
    $heard.textContent = '';
    $status.textContent = 'Escuchando…';
    $mic.classList.add('on');

    rec = new SpeechRec();
    rec.lang = 'es-ES';
    rec.interimResults = true;
    rec.continuous = false;

    // ✅ clave Android 14: parar cuando detecta fin de habla
    rec.onspeechend = () => {
      forceStop();
    };

    rec.onresult = (e) => {
      interimText = '';
      for (let i = e.resultIndex; i < e.results.length; i++){
        const txt = e.results[i][0].transcript;
        if (e.results[i].isFinal) finalText += txt;
        else interimText += txt;
      }
      const shown = (finalText || interimText || '').trim();
      $heard.textContent = shown ? `Oído: ${shown}` : '';
    };

    rec.onerror = () => {
      $status.textContent = 'No te he entendido.';
      setTimeout(() => speak('No te he entendido.'), 120);
      cleanup();
    };

    rec.onend = () => {
      const heard = (finalText || interimText || '').trim();
      cleanup();

      if (!heard) {
        $status.textContent = 'Di solo un número (ej: “54”).';
        setTimeout(() => speak('No he entendido el número.'), 120);
        return;
      }

      const n = parseNumber(heard);
      if (n === null) {
        $status.textContent = 'Di solo un número (ej: “54”).';
        setTimeout(() => speak('No he entendido el número.'), 120);
        return;
      }

      const r = discountFloor15(n);
      $result.textContent = r;
      $status.textContent = 'Listo.';
      // iOS Safari: micro-delay para que no lo ignore
      setTimeout(() => speak(r), 120);
    };

    try {
      rec.start();
    } catch {
      $status.textContent = 'No puedo iniciar el micro (permiso?).';
      setTimeout(() => speak('No puedo iniciar el micrófono.'), 120);
      cleanup();
      return;
    }
  }

  // -------- Single tap handler --------
  $mic.addEventListener('click', (e) => {
    e.preventDefault();
    unlockTTS(); // iOS: desbloquea voz en el gesto

    // si está escuchando, un tap extra corta y procesa
    if (isListening) {
      $status.textContent = 'Procesando…';
      forceStop();
      return;
    }

    startListening();
  }, { passive: false });

  $mic.addEventListener('contextmenu', (e) => e.preventDefault());

})();
</script>
</body>
</html>
